# PixiJS v7 è¿ç§»æŒ‡å—

é¦–å…ˆï¼ŒPixiJS v7 æ˜¯ä¸€ä¸ªç°ä»£åŒ–çš„ç‰ˆæœ¬ï¼Œåæ˜ äº†è‡ª PixiJS é¦–æ¬¡å‘å¸ƒä»¥æ¥ç”Ÿæ€ç³»ç»Ÿçš„å˜åŒ–ï¼Œå·²ç»è¿‡å»äº†å…­å¹´å¤šçš„æ—¶é—´ã€‚è™½ç„¶æµè§ˆå™¨å·²ç»å˜å¾—æ›´å¥½ï¼Œä½† PixiJS å®é™…ä¸Šæ²¡æœ‰å……åˆ†åˆ©ç”¨ä¸€äº›æ–°åŠŸèƒ½ï¼Œä¾‹å¦‚ `fetch`ã€`Workers` å’Œç°ä»£çš„ JavaScript è¯­è¨€è¯­æ³•ã€‚è¿™ä¸ªç‰ˆæœ¬åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šä¿ç•™äº†é«˜çº§åˆ«çš„ DisplayObjectï¼ˆä¾‹å¦‚ Spriteã€Graphicsã€Mesh ç­‰ï¼‰ã€‚é™¤äº†ä¸€äº›ç»†å¾®çš„å˜åŒ–å¤–ï¼Œå¯¹äºå¤§å¤šæ•°ç”¨æˆ·æ¥è¯´ï¼Œæ­¤ç‰ˆæœ¬çš„å½±å“åº”è¯¥æ˜¯ä¸­ç­‰åˆ°ä½ç¨‹åº¦çš„ã€‚

## ğŸ‘‹ æ”¾å¼ƒæ”¯æŒ Internet Explorer

Microsoft æ­£å¼ç»“æŸäº†å¯¹ IE çš„æ”¯æŒï¼Œå› æ­¤æˆ‘ä»¬å†³å®šä¹Ÿæ”¾å¼ƒå¯¹å®ƒçš„æ”¯æŒã€‚è¿™ç®€åŒ–äº†æˆ‘ä»¬çš„ç°ä»£åŒ–å·¥ä½œï¼Œå› ä¸º IE åœ¨ Safariã€Chromeã€Firefoxã€Edge å’Œç§»åŠ¨æµè§ˆå™¨ä¹‹å¤–ã€‚å¦‚æœæ‚¨éœ€è¦æ”¯æŒ IEï¼Œè¯·è€ƒè™‘ä½¿ç”¨ [Babel](https://babeljs.io/) æˆ–å…¶ä»–è½¬è¯‘å·¥å…·ã€‚

## ğŸ—‘ï¸ ç§»é™¤ Polyfills

æˆ‘ä»¬ç§»é™¤äº†æ†ç»‘çš„ polyfillsï¼Œå¦‚ `requestAnimationFrame` å’Œ `Promise`ã€‚è¿™äº›åŠŸèƒ½ç°åœ¨åœ¨æµè§ˆå™¨ä¸­å¾—åˆ°å¹¿æ³›æ”¯æŒã€‚å¦‚æœé¡¹ç›®éœ€è¦è¿™äº›åŠŸèƒ½ï¼Œå¼€å‘è€…åº”è¯¥æ ¹æ®éœ€è¦åŒ…å«æ‰€éœ€çš„ polyfills ä»¥ä¿æŒå‘åå…¼å®¹ã€‚æ‚¨å¯ä»¥æŸ¥çœ‹ [polyfill.io](https://cdn.polyfill.io/v3/url-builder/)ã€‚

## ğŸ’¬ è¾“å‡º ES2020ï¼ˆæ¨¡å—ï¼‰å’Œ ES2017ï¼ˆæµè§ˆå™¨ï¼‰

PixiJS å†å²ä¸Šåªå‘å¸ƒäº† ES5ï¼ˆæ²¡æœ‰ç±»ï¼ï¼‰ã€‚æ–°çš„è¾“å‡ºæ ‡å‡†ä½¿æˆ‘ä»¬èƒ½å¤Ÿä½¿ç”¨ä¹‹å‰æ— æ³•ä½¿ç”¨çš„ ES2017 åŠŸèƒ½ï¼ˆä¾‹å¦‚ `String.prototype.startsWith`ã€`Array.prototype.contains` ç­‰ï¼‰ã€‚è¿™ä¸ä»…ä½¿ä»£ç æ›´æ˜“è¯»ï¼Œè€Œä¸”è¾“å‡ºç»“æœçœ‹èµ·æ¥ä¹Ÿæ›´å¥½ã€‚å¯¹äºæ¨¡å—ï¼Œæˆ‘ä»¬è¾“å‡º ES2020ï¼Œå…¶ä¸­åŒ…å«åƒç©ºå€¼åˆå¹¶ï¼ˆ`??`ï¼‰è¿™æ ·çš„è¯­æ³•ã€‚å¦‚æœæ‚¨çš„é¡¹ç›®éœ€è¦å‘åå…¼å®¹ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ [Babel](https://babeljs.io/) è¿›è¡Œè½¬è¯‘æˆ–ä½¿ç”¨ polyfillã€‚

## ğŸ­ ç”¨ EventSystem æ›¿æ¢ InteractionManager

InteractionManager å˜å¾—å¤æ‚ä¸”éš¾ä»¥ç»´æŠ¤ã€‚åªæœ‰å°‘æ•°æ ¸å¿ƒå›¢é˜Ÿæˆå‘˜ç†è§£å…¶ä»£ç ã€‚æˆ‘ä»¬å†³å®šè½¬å‘ä½¿ç”¨ FederatedEventsï¼Œå®ƒæ›´ç®€æ´ï¼Œæ›´ç¬¦åˆ DOMï¼Œè¿˜æ”¯æŒå†’æ³¡ç­‰ç‰¹æ€§ã€‚å¥½æ¶ˆæ¯æ˜¯ï¼Œæ‚¨ä¸éœ€è¦æ›´æ”¹ä»£ç ï¼Œå› ä¸ºå®ƒåœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šæ˜¯ä¸€ä¸ªæ’å…¥å¼æ›¿æ¢ã€‚æˆ‘ä»¬åœ¨ DisplayObject ä¸­æ·»åŠ äº† `addEventListener` å’Œ `removeEventListener` APIï¼Œå…¶å…·æœ‰ä¸ DOM ç›¸åŒçš„ç­¾åï¼Œå¯ä»¥ä»£æ›¿ `on` å’Œ `off`ã€‚

## ğŸ“¦ ç”¨ Assets æ›¿æ¢ Loader

ç±»ä¼¼åœ°ï¼Œç”±äº Loader ä½¿ç”¨äº†è¿‡æ—¶çš„æ–¹æ³•ï¼ˆä¾‹å¦‚ XMLHttpRequestï¼‰ï¼Œæˆ‘ä»¬ä¸€ç›´æƒ³è¦å°†å…¶åˆ é™¤ã€‚Loader æœ€åˆæ˜¯ä» [resource-loader](https://github.com/englercj/resource-loader) åˆ†æ”¯å‡ºæ¥çš„ï¼Œå®ƒå·²ç»åœ¨ PixiJS ä¸­å­˜åœ¨å¾ˆé•¿æ—¶é—´ã€‚Loader çš„åŸå§‹è®¾è®¡çµæ„Ÿä¸»è¦æ¥è‡ª Flash/AS3ï¼Œç°åœ¨çœ‹èµ·æ¥æœ‰äº›è¿‡æ—¶äº†ã€‚æˆ‘ä»¬å¯¹æ–°ç‰ˆæœ¬æœ‰ä¸€äº›æœŸæœ›ï¼šé™æ€åŠ è½½ã€ä½¿ç”¨ Workers åŠ è½½ã€åå°åŠ è½½ã€åŸºäº Promiseã€è¾ƒå°‘çš„ç¼“å­˜å±‚çº§ã€‚ä»¥ä¸‹æ˜¯è¿™ä¸ªæ”¹å˜çš„ä¸€ä¸ªå¿«é€Ÿç¤ºä¾‹ï¼š

```js
import { Loader, Sprite } from 'pixi.js';

const loader = new Loader();
loader.add('background', 'path/to/assets/background.jpg');
loader.load((loader, resources) => {
  const image = Sprite.from(resources.background.texture);
});
```

ç°åœ¨å˜æˆäº†ï¼š

```js
import { Assets, Sprite } from 'pixi.js';

const texture = await Assets.load('path/to/assets/background.jpg');
const image = Sprite.from(texture);
```

## ğŸ¤ æ”¾å¼ƒä½¿ç”¨ peerDependencies

~~PixiJS åœ¨æ¯ä¸ªåŒ…çš„ **package.json** ä¸­å¹¿æ³›ä½¿ç”¨äº† `peerDependencies`ã€‚è¿™ä¸ªè®¾è®¡é€‰æ‹©ç»™ PixiJS å¸¦æ¥äº†è®¸å¤šé—®é¢˜ã€‚åˆ é™¤å®ƒæ˜¯ä¸€ä¸ªç ´åæ€§çš„å˜åŒ–ï¼Œæ‰€ä»¥ç°åœ¨æ˜¯ä¸€ä¸ªå¥½æ—¶æœºã€‚æˆ‘ä»¬å†³å®šå®Œå…¨åˆ é™¤ `peerDependencies`ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯ _ä»€ä¹ˆä¹Ÿä¸ä¾èµ–_ã€‚è¿™åº”è¯¥ä¼šä½¿å®‰è£…å’Œå‡çº§ `pixi.js` å˜å¾—æ›´åŠ å®¹æ˜“ã€‚æˆ‘ä»¬æ­£åœ¨æ›´æ–° [æˆ‘ä»¬çš„å·¥å…·](https://pixijs.io/customize) æ¥ç»„åˆä¸€ä¸ªåŒ…å«å¤šä¸ªåŒ…çš„è‡ªå®šä¹‰ç‰ˆæœ¬ã€‚~~ **ç¼–è¾‘ï¼šæˆªè‡³ v7.2.0ï¼Œæˆ‘ä»¬å·²ç»æ’¤é”€äº†è¿™ä¸ªæ›´æ”¹ï¼Œä»¥ä¿æŒä¸æŸäº›åŸºäºæ¨¡å—çš„ CDN çš„å…¼å®¹æ€§ã€‚**

## ğŸ‘‚ å…¶ä»–å˜åŒ–

* æ‰€æœ‰åŒ…çš„æµè§ˆå™¨æ„å»ºå·²è¢«åˆ é™¤ï¼Œä¾‹å¤–æ˜¯ `pixi.js` å’Œ `pixi.js-legacy`ã€‚
* ç§»é™¤äº† `Graphics.nextRoundedRectBehavior`ï¼Œè¿™ç°åœ¨æ˜¯é»˜è®¤è¡Œä¸ºã€‚
* ç§»é™¤äº† `Text.nextLineHeightBehavior`ï¼Œè¿™ç°åœ¨æ˜¯é»˜è®¤è¡Œä¸ºã€‚
* ç§»é™¤äº† `AbstractBatchRenderer` å’Œ `BatchPluginFactory`ã€‚è¦ä¹ˆæ‰©å±• `BatchRenderer`ï¼Œè¦ä¹ˆåœ¨é»˜è®¤çš„ BatchRenderer ä¸Šä½¿ç”¨ `setShaderGenerator`ï¼ˆä¾‹å¦‚ `renderer.plugins.batch`ï¼‰ã€‚
* BatchRenderer ç°åœ¨é»˜è®¤å®‰è£…åœ¨ `@pixi/core` ä¸­ï¼Œä¸å†éœ€è¦ `Renderer.registerPlugin('batch', BatchRenderer)`ã€‚

### ä» `@pixi/core` å¯¼å‡º

`@pixi/core` åŒ…ç°åœ¨ä¾èµ–å¹¶é‡æ–°å¯¼å‡ºäº†ä»¥ä¸‹åŒ…ã€‚

* `@pixi/math`
* `@pixi/contants`
* `@pixi/utils`
* `@pixi/runner`
* `@pixi/settings`
* `@pixi/ticker`

è™½ç„¶æŸäº›åŒ…åœ¨ç›´æ¥å®‰è£…æ—¶ä»ç„¶å¯ä»¥å·¥ä½œï¼Œä½†å…¶ä»–åŒ…åˆ™ä¸è¡Œï¼Œå› ä¸ºå°†å®ƒä»¬ä¸ `@pixi/core` ä¸€èµ·å®‰è£…ä¼šæœ‰æ•ˆåœ°å¯¼å…¥ä¸¤ä¸ªç›¸åŒä»£ç çš„å‰¯æœ¬ã€‚
è¿™å°†å¯¼è‡´åœ¨ä» `@pixi/settings` æ›´æ”¹è®¾ç½®æ—¶ä¸èµ·ä½œç”¨ï¼Œå› ä¸º `@pixi/core`

æœ‰å…¶è‡ªå·±çš„è¯¥åŒ…ç‰ˆæœ¬ã€‚
å»ºè®®æ‚¨ä»é¡¹ç›®ä¸­å¸è½½è¿™äº›åŒ…ï¼Œå¹¶æ”¹ä¸ºä½¿ç”¨ `@pixi/core`ã€‚

```js
import { Rectangle } from '@pixi/math';
import { settings } from '@pixi/settings';
import { ALPHA_MODES } from '@pixi/constants';
import { string2hex } from '@pixi/utils';
```
ç°åœ¨å˜æˆï¼š
```js
import { Rectangle, settings, ALPHA_MODES, utils } from '@pixi/core';

const { string2hex } = utils;
```

### æå–å’Œå‡†å¤‡ç³»ç»Ÿ

æå–å’Œå‡†å¤‡æ’ä»¶å·²è¢«è½¬æ¢ä¸ºæ¸²æŸ“å™¨çš„â€œç³»ç»Ÿâ€ã€‚

```js
renderer.plugins.extract
renderer.plugins.prepare
```

ç°åœ¨å˜æˆï¼š

```js
renderer.extract
renderer.prepare
```

### æ‰©å±•è‡ªå®‰è£…

æ‰©å±•ç°åœ¨ä¼šè‡ªè¡Œå®‰è£…ï¼Œæ‰€ä»¥æ‚¨åªéœ€è¦å¯¼å…¥ç±»å³å¯ä½¿ç”¨ã€‚ä¾‹å¦‚ï¼Œåœ¨ v6 ä¸­ï¼š

```js
import { AccessibilityManager } from '@pixi/accessibility';
import { extensions } from '@pixi/core';
extensions.add(AccessibilityManager);
```

ç°åœ¨å˜æˆï¼š

```js
import '@pixi/accessibility';
```

### åœ¨äº‹ä»¶ä¸­ä½¿ç”¨ hitTest

ä½¿ç”¨æ–°çš„äº‹ä»¶ç³»ç»Ÿï¼Œä¸€ä¸ªå¸¸è§çš„ API å‘ç”Ÿäº†å˜åŒ–ï¼Œå³ `hitTest`ã€‚

```js
import {Application} from 'pixi.js';

const app = new Application();
app.renderer.plugins.interaction.hitTest({x, y});
```

ç°åœ¨å˜æˆï¼š

```js
import {Application, EventBoundary} from 'pixi.js';

const app = new Application();
const boundary = new EventBoundary(app.stage);
boundary.hitTest(x, y);
```

### æ–°çš„å¼‚æ­¥æå–æ–¹æ³•

ä»¥ä¸‹æ–¹æ³•ç°åœ¨æ˜¯å¼‚æ­¥çš„ï¼Œå¹¶è¿”å›ä¸€ä¸ª Promiseã€‚

* `CanvasExtract.base64()`
* `CanvasExtract.image()`
* `Extract.base64()`
* `Extract.image()`

```js
import {Application, EventBoundary} from 'pixi.js';

const app = new Application();
const dataUri = app.renderer.extract.base64();
```

ç°åœ¨å˜æˆï¼š
```js
import {Application, EventBoundary} from 'pixi.js';

const app = new Application();
const dataUri = await app.renderer.extract.base64();
```

### äº¤äº’å¼ç§»åŠ¨äº‹ä»¶

PixiJS ä¸­çš„äº¤äº’äº‹ä»¶ç°åœ¨åœ¨ v7 ä¸­çš„è¡Œä¸ºä¸ DOM ç±»ä¼¼ã€‚è¿™æ˜¯æœ‰æ„ä¸ºä¹‹ï¼Œä»¥ä¾¿ä¸å¼€å‘è€…ç†Ÿæ‚‰çš„è¡Œä¸ºç›¸åŒ¹é…ï¼Œä½†æ˜¾ç„¶ä¼šå½±å“ `pointermove`ã€`mousemove` å’Œ `touchmove` çš„è¡Œä¸ºã€‚

ä¸ DOM ä¸€æ ·ï¼Œç§»åŠ¨äº‹ä»¶ç°åœ¨æ˜¯ _å±€éƒ¨çš„_ã€‚è¿™æ„å‘³ç€å¦‚æœæ‚¨è¶…å‡ºäº†å¯¹è±¡çš„è¾¹ç•Œï¼Œæ‚¨å°†ä¸ä¼šæ”¶åˆ°ç§»åŠ¨äº‹ä»¶ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œæ‚¨åº”è¯¥è€ƒè™‘å°†ç§»åŠ¨äº‹ä»¶æ·»åŠ åˆ°èˆå°æˆ–çˆ¶çº§ï¼Œè€Œä¸æ˜¯ DisplayObject æœ¬èº«ã€‚

å·¥ä½œç¤ºä¾‹ï¼šhttps://jsfiddle.net/bigtimebuddy/spnv4wm6/

### ç§»é™¤äº¤äº’å±æ€§å¤„ç†ç¨‹åº

åŸºäºå±æ€§çš„äº‹ä»¶å¤„ç†ç¨‹åºå·²ä»äº‹ä»¶ä¸­ç§»é™¤ã€‚è¿™æ˜¯æ—§çš„ InteractionManager çš„ä¸€ä¸ªç‰¹æ€§ã€‚ä¾‹å¦‚ï¼š

```js
sprite.pointertap = () => {
 // å¤„ç† pointertap
};
```

ç°åœ¨å˜æˆï¼š

```js
sprite.on('pointertap', () => {
 // å¤„ç† pointertap
});
```

### å±æ€§ `buttonMode` å·²è¢«ç§»é™¤

å±æ€§ `buttonMode` æ˜¯åœ¨ `pointer` å’Œ `null` ä¹‹é—´åˆ‡æ¢ `cursor` å±æ€§çš„ä¾¿æ·æ–¹å¼ã€‚ç°åœ¨å·²ç»è¢«ç§»é™¤ã€‚

```js
sprite.buttonMode = true;
```

ç°åœ¨å˜æˆï¼š

```js
sprite.cursor = 'pointer';
```

å¦‚æœæ‚¨æƒ³é‡æ–°æ·»åŠ æ­¤åŠŸèƒ½ï¼Œå¯ä»¥[åœ¨ DisplayObject çš„åŸå‹ä¸Šè¿›è¡Œè¡¥ä¸](https://jsfiddle.net/bigtimebuddy/ygka52dr/)ï¼š

```js
import { DisplayObject } from 'pixi.js';

Object.defineProperty(DisplayObject.prototype, 'buttonMode', {
  get() { return this.cursor === 'pointer'; },
  set(value) { this.cursor = value ? 'pointer' : null; },
});
```

## â˜ï¸ å‡çº§å»ºè®®

å¦‚æœæ‚¨è®¡åˆ’ä» v6 è¿ç§»åˆ°æ–°ç‰ˆæœ¬ï¼Œå»ºè®®æ‚¨é¦–å…ˆåœ¨å‡çº§åˆ° v7 ä¹‹å‰å…ˆå®æ–½ä¸€äº›è¾ƒå¤§çš„ v6 æ›´æ”¹ï¼š

* æ›´æ–°åˆ°æœ€æ–°çš„ v6.5.x ç‰ˆæœ¬ã€‚
* [åˆ‡æ¢åˆ° Events åŒ…](https://codesandbox.io/s/pixijs-uninstall-interaction-ke6u3q)ï¼šé€šè¿‡å®‰è£… `@pixi/events` å¹¶æ›¿æ¢ InteractionManager æ¥å®ç°ã€‚ä¾‹å¦‚ï¼š
```js
import { InteractionManager, extensions, Application } from 'pixi.js';
import { EventSystem } from '@pixi/events';

// å¸è½½äº¤äº’åŠŸèƒ½
extensions.remove(InteractionManager);

// åˆ›å»ºæ¸²æŸ“å™¨æˆ–åº”ç”¨ç¨‹åº
const app = new Application();

// å®‰è£…äº‹ä»¶
app.renderer.addSystem(EventSystem, 'events');
```
* åˆ‡æ¢åˆ° Assets åŒ…ï¼šé€šè¿‡å®‰è£… `@pixi/assets` å¹¶æ›¿æ¢ Loader æ¥å®ç°ã€‚æœ‰å…³å®æ–½ Assets çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜… [æ­¤æŒ‡å—](https://pixijs.io/guides/basics/assets.html)ã€‚
* è®¾ç½® `Graphics.nextRoundedRectBehavior = true`ï¼Œè¿™ä¼šä½¿ç”¨åœ†å¼§æ¥ä»£æ›¿è´å¡å°”æ›²çº¿å®ç°åœ†è§’åŠå¾„ã€‚
* è®¾ç½® `Text.nextLineHeightBehavior = true`ï¼Œè¿™ä¼šé»˜è®¤ä½¿ç”¨ç±»ä¼¼äº DOM çš„è¡Œé«˜è¡Œä¸ºã€‚

## ğŸ—ï¸ æ”¯æŒçš„æ’ä»¶

| æ’ä»¶ | å…¼å®¹æ€§ | æ”¯æŒçš„æ’ä»¶ç‰ˆæœ¬ |
|---|---|---|
| [PixiJS Sound](https://github.com/pixijs/sound) | âœ… | v5.0.0+ |
| [PixiJS HTMLText](https://github.com/pixijs/html-text) | âœ…  | v3.0.0+ |
| [PixiJS Filters](https://github.com/pixijs/filters) | âœ… | v5.0.0+ |
| [PixiJS GIF](https://github.com/pixijs/gif) | âœ… | v2.0.0+ |
| [PixiJS Spine](https://github.com/pixijs/spine) | âœ… | v4.0.0+ |
| [PixiJS Particle Emitter](https://github.com/pixijs/particle-emitter) | âœ… | v5.0.8+ |
| [PixiJS Animate](https://github.com/pixijs

/animate) | âŒ | |
| [PixiJS Layers](https://github.com/pixijs/layers) | âœ… | v2.0.0+ |
| [PixiJS Lights](https://github.com/pixijs/lights) | âœ… | v4.0.0+ |
| [PixiJS Graphics Smooth](https://github.com/pixijs/graphics-smooth) | âœ… | v1.0.0+ |
| [PixiJS Tilemap](https://github.com/pixijs/tilemap) | âŒ | |
